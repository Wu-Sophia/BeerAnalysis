---
title: "DDS Group Project"
author: "Chad Reo"
date: "6/24/2020"
output: html_document
---
```{r}
#Load Libraries and Data 
library(dplyr)
library(grid)
library(ggplot2)
library(tidyr)
library(maps)
library(usmap)
library(stringr)
library(class)
library(caret)
library(Hmisc)
library(gridExtra)
library(naniar)
```

##1. Number of Breweries Per State
#merged Data first
```{r}
breweries <- read.csv("~/Documents/SMU/DS6306 Doing DS/CaseStudy1_2_2_2_2_2-2/Breweries.csv")
beer<- read.csv("~/Documents/SMU/DS6306 Doing DS/CaseStudy1_2_2_2_2_2-2/Beers.csv")

```
#2. Merge Beer Data with Brewery  Data
```{r}
beerBrew=merge(beer,breweries,by.x="Brewery_id",by.y="Brew_ID")
beerBrew$Brewery_id = as.factor(beerBrew$Brewery_id)
beerBrew$Beer_ID = as.factor(beerBrew$Beer_ID)

#add in map data
stateCoords=us_map()
# Remove Leading Spaces from State Column of merged Beer Brew Data frame (prepare for join)
beerBrew$State = gsub(" ","",beerBrew$State)
str(beerBrew)

# Summarise Each State's Number of Breweries and Beers
stateBrewBeer1 = beerBrew %>% 
  select(State, Brewery_id) %>% 
  group_by(State, Brewery_id) 
stateBrewBeer2 = stateBrewBeer1 %>% distinct(State, Brewery_id) 
stateBrewBeer3 = stateBrewBeer2 %>%  group_by(State) %>% tally()
stateBrewBeer3$state = stateBrewBeer3$State 


#plot map
plot_usmap(data=stateBrewBeer3,values="n",labels = TRUE, offset=0.5, color = "red")  +
  scale_fill_continuous(low = "white", high = "red", name="Number Breweries")+ 
  theme(legend.position = "right") +
  labs(title = "Brewery Count",
       subtitle = "Darker Areas have the Most Breweries") + 
  theme(panel.background = element_rect(color = "black", fill = "lightblue"))

```
#3. Address the missing values in each column.
```{r}
# plot missing values in each column, rename some columns
gg_miss_var(beerBrew%>%rename(Beer_Name=Name.x,Brewery_Name=Name.y,Brewery_ID=Brewery_id)
            %>%select(IBU,ABV,Style,State,Ounces,City,Brewery_Name,Beer_Name,
                      Brewery_ID,Beer_ID))

# convert empty string Styles to NAs to more easily see missings in all columns
beerBrew$Style[which(beerBrew$Style=="")]=NA
sapply(beerBrew, function(x) sum(is.na(x)))

```
#4.Compute the median alcohol content and international bitterness unit for each state. 
#Plot a bar chart to compare.
```{r}
beerBrew %>% group_by(State) %>%
  filter(!is.na(ABV))%>%
  summarise(ABV=median(ABV)) %>%
  ggplot(aes(x=reorder(State,-ABV),ABV)) +
  geom_bar(stat="identity", position="dodge", color='skyblue',fill='steelblue') + 
  # scale_y_continuous(limits = c(0.5,0.07))+
  coord_flip()+ 
  xlab("State") +  ylab("ABV") + ggtitle("Median ABV by State")+ 
  theme(text = element_text(size=20,color= 'green'))


beerBrew %>% group_by(State) %>%
  filter(!is.na(IBU))%>%
  summarise(IBU=median(IBU)) %>%
  ggplot(aes(x=reorder(State,-IBU),IBU)) +
  geom_bar(stat="identity", position="dodge", color='skyblue',fill='steelblue') + 
  coord_flip()+ 
  xlab("State") +  ylab("IBU") + ggtitle("Median IBU by State")+
  theme(text = element_text(size=20,color= 'green'))
```
#5. (part 1) Which state has the maximum alcoholic (ABV) beer? 
#Which state has the most bitter (IBU) beer?
```{r}
#find the single most ABV beer
beerBrew %>% filter(!is.na(ABV)) %>% mutate(maxABV=max(ABV)) %>%
  filter(ABV==maxABV) %>%select(State,Name.x,Name.y,ABV)

#find the single most bitter beer
beerBrew %>% filter(!is.na(IBU)) %>% mutate(maxIBU=max(IBU)) %>%
  filter(IBU==maxIBU)%>%select(State,Name.x,Name.y,IBU)

```
#6.Comment on the summary statistics and distribution of the ABV variable
#The ABV is mostly normally distributed with a noticeable right tail.  
#The mean is Larger than the median.
```{r}
#Check for normality of ABV using qq plot and histogram
beerBrew %>% filter(!is.na(ABV)) %>% ggplot() +stat_qq(aes(sample=ABV)) 
beerBrew %>% filter(!is.na(ABV)) %>% ggplot()+geom_histogram(aes(ABV))
beerBrew %>% filter(!is.na(ABV)) %>% select(ABV)%>%summary()
```
#7. Is there an apparent relationship between the bitterness of the beer and its alcoholic content? Draw a scatter plot.  Make your best judgment of a relationship and EXPLAIN your answer.
#There is a moderate positive correlation between ABV and IBU.  
#The upward slope is evidence of a positive relationship.  The points' moderate to small deviations from the trendline is clear evidence of a moderate to weak relationship.
```{r}
beerBrew %>% filter(!is.na(ABV)&!is.na(IBU))%>%
  ggplot(aes(ABV,IBU,color=StyleCat))+geom_point(position=position_jitter(width=0.01),alpha=0.5)+
  geom_smooth(method="lm",se=FALSE,size=2) +labs(title="Correlation between ABV and IBU") 


```
#8.1 Group beer styles into larger style buckets
#Categorize the many styles into 5 groups
```{r}
beerBrew$StyleCat= case_when(
  grepl("(India Pale Ale|IPA)",beerBrew$Style) ~ "IPA",
  grepl( "Ale",beerBrew$Style) ~ "Ale",
  grepl("Lager",beerBrew$Style)~"Lager",
  grepl("Stout",beerBrew$Style)~"Stout",
  TRUE~"Other"
)

```
#9 Knock their socks off!  Find one other useful inference from 
#the data that you feel Budweiser may be able to find value in.

```{r}
###Get population
library(tidyr)
library(plyr)
library(jsonlite)
library(dplyr)
library(tidyverse)

#go get Key from USCensus
US_Census_KEY = "3094ca397d1d50a4e3a230346dbaf7d801f753d4" #Your Key Here â¦ get from US Census website

#Pull Json data
Json <- "https://api.census.gov/data/2018/acs/acs1?get=NAME,B01001_001E&for=state:*"


#put in Dataframe
get_json <- jsonlite::fromJSON(Json, flatten = TRUE)
str(get_json)
Pop_df <- as.data.frame(get_json)
str(Pop_df)
colnames(Pop_df)
head(Pop_df)

#clean up by renaming columns and dropping unneeded columns/rows
names(Pop_df)[1] <- "State"
names(Pop_df)[2] <- "Population"
head(Pop_df)

#clean up by dropping unneeded columns/rows
Pop_df <- select(Pop_df, -3)
Pop_df <- Pop_df[-c(1),]

#change factor to numeric
Pop_df$Population <- as.numeric(as.character(Pop_df$Population))

view(Pop_df)
head(Pop_df)
summary(Pop_df)

#take a look at data
Pop_df[order(Pop_df$Population),]

#graph Population
library(scales)
Pop_df  %>% 
  ggplot(aes(x = reorder(State, -Population), y = Population)) +
  geom_bar(stat = "identity", fill = "blue") + 
  #theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels = unit_format(unit = "M", scale = 1e-6)) +
  labs(title = "US Population by State",
       subtitle = "Source:  US Census Estimate for 2018") + 
  xlab("State") + coord_flip() +
  theme(panel.background = element_rect(color = "black", fill = "lightblue"))

#pull out abbr from Coordinates map
StateNames <- stateCoords %>% select(abbr, full) %>% distinct(abbr, full)

#get style count by State
StyleCnt <- beerBrew %>% mutate(State=gsub(" ","",State)) %>%
  select(Style, State) %>% 
  filter(!is.na(Style)) %>% group_by(Style, State) %>% tally()

#add Abbr to State Names
StatePop = merge(StateNames,Pop_df,by.x="full",by.y="State")

#Merge Population and Beer Data
Revenue_DF = merge(StatePop,stateBrewBeer,by.x="abbr",by.y="state")
str(Revenue_DF)
Revenue_DF[order(Revenue_DF$beers/log(Revenue_DF$Population)),]

#check normality of Beer/Pop data
library("ggpubr")
ggqqplot(Revenue_DF$beersPerLogPop, ylab = "beersPerLogPop",
         ggtheme = theme_minimal())

#histogram
ggplot()+geom_histogram(aes(Revenue_DF$beers/log(Revenue_DF$Population)))

#add metrics
Revenue_DF = Revenue_DF %>% mutate(LogPop = log(Population),
                                  brewsPerLogPop = brews/log(Population),
                                  beersPerLogPop = beers/log(Population))


#Look at data points with high residual error
Revenue_DF %>% filter(beersPerLogPop < 7.5) %>% 
  ggplot(aes(LogPop,beersPerLogPop)) +
  geom_point(position=position_jitter(width=0.01),alpha=0.5)+
  geom_smooth(method="lm",se=FALSE,size=2) +
  labs(title="Correlation between Population and Count of Beers") 

#Look at data points with high residual error
Revenue_DF %>% filter(brewsPerLogPop < 2) %>% 
  ggplot(aes(LogPop,brewsPerLogPop)) +
  geom_point(position=position_jitter(width=0.01),alpha=0.5)+
  geom_smooth(method="lm",se=FALSE,size=2) +
  labs(title="Correlation between Population and Count of Breweries") 

#get low values as areas to focus
Revenue_DF %>% filter(beersPerLogPop <= 1.5,
                      LogPop > 15.5)
Revenue_DF %>% filter(brewsPerLogPop <= .5,
                      LogPop > 15.5)


Revenue_DF_Compare_North <- beerBrew %>% 
  filter(State == "MD" | State == "NJ") %>% 
  select (StyleCat) %>%
  group_by(StyleCat) %>% 
  tally()
Revenue_DF_Compare_North

Revenue_DF_Compare_South <- beerBrew %>% 
  filter(State == "GA" | State == "TN") %>% 
  select (StyleCat) %>%
  group_by(StyleCat) %>% 
  tally()
Revenue_DF_Compare_South
```
